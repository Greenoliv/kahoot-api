<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/client.js | kahoot-api</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="An api for the Kahoot quiz service."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="kahoot-api"><meta property="twitter:description" content="An api for the Kahoot quiz service."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/idiidk/kahoot-api"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/client.js~Client.html">Client</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/helpers.js~Helpers.html">Helpers</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/player.js~Player.html">Player</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/client.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import axios from &quot;axios&quot;
import emitter from &quot;tiny-emitter/instance&quot;
import cometd from &quot;cometd&quot;
import cometdAdapter from &quot;cometd-nodejs-client&quot;

import Helpers from &quot;./helpers&quot;
import Player from &quot;./player&quot;

if (typeof window === &quot;undefined&quot;) {
  cometdAdapter.adapt()
}

/**
 * Client class, used as controller for players.
 * Also initializes the socket communication.
 *
 * @class Client
 */
export default class Client extends Player {
  /**
   * @param {Number} pin The game pin
   * @param {String} name Name of the main player
   */
  constructor(pin, name) {
    super(null, Helpers.randomCid(), pin)

    this.pin = pin
    this.name = name
    this.emitter = emitter
    this.cometd = null
    this.twoFactor = null
  }

  /**
   * Checks session and initializes communication, must be called first!
   * 
   * @return {Promise&lt;Object&gt;} Returns CometD client
   */
  initialize() {
    return this.checkSession()
      .then(this.createSocket)
      .then(e =&gt; this.cometd = e)
  }

  /**
   * Initializes CometD client
   * 
   * @return {Promise&lt;Object&gt;} Returns CometD client
   */
  createSocket(parsed) {
    const socket = new cometd.CometD()
    socket.configure({
      url: `https://kahoot.it/cometd/${parsed.pin}/${parsed.session}`
    })
    socket.websocketEnabled = true

    return new Promise((resolve, reject) =&gt; {
      socket.handshake((h) =&gt; {
        if (!h.successful) return reject(Error(&quot;session failed decoding&quot;))
        socket.subscribe(&quot;/service/controller&quot;, m =&gt; emitter.emit(&quot;controller&quot;, m))
        socket.subscribe(&quot;/service/player&quot;, m =&gt; emitter.emit(&quot;player&quot;, m))
        socket.subscribe(&quot;/service/status&quot;, m =&gt; emitter.emit(&quot;status&quot;, m))

        resolve(socket)
      })
    })
  }

  /**
   * Checks existance of pin
   * 
   * @return {Promise&lt;Object&gt;} Returns object containing session information
   */
  checkSession() {
    return axios.get(`https://www.kahoot.it/reserve/session/${this.pin}/?${Helpers.getTime()}`)
      .then((res) =&gt; {
        const sessionInfo = res.data
        const headers = res.headers
        const rawSession = headers[&quot;x-kahoot-session-token&quot;]
        const solvedChallenge = Helpers.solveChallenge(sessionInfo.challenge)
        const twoFactor = sessionInfo.twoFactorAuth
        const session = Helpers.shiftBits(rawSession, solvedChallenge)

        this.twoFactor = twoFactor

        return {
          pin: this.pin,
          twoFactor: twoFactor,
          session: session
        }
      })
  }

  /**
   * Adds main player to the game, this is normally called after initialize to get other functions working.
   * Automatically bruteforces 2FA
   * 
   * @return {Promise&lt;&gt;} Returns when complete
   */
  doLogin() {
    this.sendPacket(
        &quot;/service/controller&quot;, {
          gameid: this.pin,
          host: &quot;kahoot.it&quot;,
          name: this.name,
          type: &quot;login&quot;
        })
      .then(() =&gt; {
        return new Promise((resolve, _) =&gt; {
          if (this.twoFactor) {
            setTimeout(() =&gt; {
              this.bruteForceTwoFactor()
              resolve()
            }, 250)
          }
        })
      })
  }

  /**
   * Adds a player to the game
   * 
   * @param {String} name The name of the player
   * @param {String} cid The unique id of the player, helper function randomCid can be used for this
   * @param {Boolean} isGhost Makes player ghost or normal
   * 
   * @return {Player} Returns object containing session information
   */
  addPlayer(name, cid, isGhost) {
    this.sendPacket(`/controller/${this.pin}`, {
      type: &quot;joined&quot;,
      cid: cid,
      image: &quot;@idiidk&quot;,
      name: name,
      isGhost: isGhost,
      completedTwoFactorAuth: 1
    })

    return new Player(this.cometd, cid, this.pin);
  }
}</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
